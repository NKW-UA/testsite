"use strict"
$(function(){function t(t){t.target.set({cornerSize:T}),i(t),$(".cvtoolbox","#centerLayoutContainer").show(),t.target.isType("i-text")?(f(t.target),$(".texttoolbox","#rightLayoutContainer").show()):$(".texttoolbox","#rightLayoutContainer").hide()}function e(t){$(".cvtoolbox","#centerLayoutContainer").hide(),$(".cvtoolbox_info","#centerLayoutContainer").hide(),$(".texttoolbox","#rightLayoutContainer").hide()}function o(t){i(t)}function i(t){if(t.target.isType("image")&&(t.target.getScaleX()>1||t.target.getScaleY()>1))u("<i class='fa fa-warning'></i> The scaled image is larger than the original image. The quality may decrease.")
else if(t.target.isType("group")){for(var e=t.target.getObjects(),o=t.target.getScaleX(),i=t.target.getScaleY(),n=!1,a=0;a<e.length;a++)if(e[a].isType("image")&&(e[a].getScaleX()*o>1||e[a].getScaleY()*i>1)){u("<i class='fa fa-warning'></i> The scaled image is larger than the original image. The quality may decrease."),n=!0
break}n||g("")}else g("")}function n(t){var e=10
j[$(y.getElement()).attr("id")]={width:y.getWidth()/y.getZoom()-t.target.getLeft()-e,scaleX:t.target.getScaleX()},t.target.setSelectionEnd(t.target.getText().length),t.target.setSelectionStart(t.target.getText().length),y.renderAll(),f(t.target)}function a(t){t.target.isType("i-text")&&(f(t.target),0==t.target.getText().length&&y.remove(t.target))}function r(t){if(t.target._initDimensions(),t.target.getText().length>0){var e=$(y.getElement()).attr("id"),o=j[e].width/t.target.getWidth();(1>o||j[e].scaleX>t.target.getScaleX())&&(t.target.getScaleX()*o>j[e].scaleX&&(o=j[e].scaleX/t.target.getScaleX()),t.target.setScaleX(t.target.getScaleX()*o),t.target.setScaleY(t.target.getScaleY()*o),t.target.setCoords(),y.renderAll())}}function l(){var t=$("input[name=form_shirt_type]:checked","#leftLayoutContainer").val(),e=$("input[name=form_shirt_color]:checked","#leftLayoutContainer").val(),o=$.grep(C[t].color,function(t){return t.id==e})
o.length>0&&$("#img_shirt").attr("src","images/shirts/"+C[t].filename+"_"+o[0].filename+"_"+L+".png")}function c(){$("#centerLayoutContainer").height($("#centerLayoutContainer div.shirt").width())
var t=s()
$("#div_canvas_front").css("margin-top",W*t),$("#div_canvas_back").css("margin-top",W*t),A.setWidth(O*t),A.setHeight(S*t),A.setZoom(d()),A.renderAll(),k.setWidth(O*t),k.setHeight(S*t),k.setZoom(d()),k.renderAll()}function s(){return $("#centerLayoutContainer div.shirt").width()/w}function d(){return O*s()/F}function g(t){$(".cvtoolbox_info div span","#centerLayoutContainer").text(t),$(".cvtoolbox_info","#centerLayoutContainer").removeClass("warning_msg").show()}function u(t){$(".cvtoolbox_info div span","#centerLayoutContainer").html(t),$(".cvtoolbox_info","#centerLayoutContainer").addClass("warning_msg").show()}function f(t){var e='<div class="btn-group" data-toggle="buttons">'
e+="bold"==t.getFontWeight()?'<label class="btn btn-default active" id="texttoolbox_bold"><input type="checkbox" autocomplete="off" istool="bold" checked><i class="fa fa-bold"></i></label>':'<label class="btn btn-default" id="texttoolbox_bold"><input type="checkbox" autocomplete="off" istool="bold"><i class="fa fa-bold"></i></label>',e+="italic"==t.getFontStyle()?'<label class="btn btn-default active" id="texttoolbox_italic"><input type="checkbox" autocomplete="off" istool="italic" checked><i class="fa fa-italic"></i></label>':'<label class="btn btn-default" id="texttoolbox_italic"><input type="checkbox" autocomplete="off" istool="italic"><i class="fa fa-italic"></i></label>',e+=t.getTextDecoration().indexOf("underline")>=0?'<label class="btn btn-default active" id="texttoolbox_underline"><input type="checkbox" autocomplete="off" istool="underline" checked><i class="fa fa-underline"></i></label>':'<label class="btn btn-default" id="texttoolbox_underline"><input type="checkbox" autocomplete="off" istool="underline"><i class="fa fa-underline"></i></label>',e+=t.getTextDecoration().indexOf("line-through")>=0?'<label class="btn btn-default active" id="texttoolbox_strikethrough"><input type="checkbox" autocomplete="off" istool="strikethrough" checked><i class="fa fa-strikethrough"></i></label>':'<label class="btn btn-default" id="texttoolbox_strikethrough"><input type="checkbox" autocomplete="off" istool="strikethrough"><i class="fa fa-strikethrough"></i></label>',e+=t.isEditing?'<label class="btn btn-default active" id="texttoolbox_edit"><input type="checkbox" autocomplete="off" istool="edit" checked><i class="fa fa-pencil-square-o fa-lg"></i></label>':'<label class="btn btn-default" id="texttoolbox_edit"><input type="checkbox" autocomplete="off" istool="edit"><i class="fa fa-pencil-square-o fa-lg"></i></label>',e+="</div>",e+='<div class="input-group colorpicker-component" id="texttoolbox_color">',e+='Text color&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="btn btn-default add-on"><i></i></span>',e+="</div>",$(".texttoolbox","#rightLayoutContainer").html(e),$("#texttoolbox_color").colorpicker({format:"hex",color:t.getFill()}).on("changeColor",b)}function b(t){var e=y.getActiveObject()
e&&e.isType("i-text")&&(e.setFill(t.color.toHex()),y.renderAll())}function h(){var t=y.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_bold input").prop("checked")?t.setFontWeight("bold"):t.setFontWeight("normal"),y.renderAll())}function v(){var t=y.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_italic input").prop("checked")?t.setFontStyle("italic"):t.setFontStyle("normal"),y.renderAll())}function p(){var t=y.getActiveObject()
if(t&&t.isType("i-text")){var e=t.getTextDecoration().replace("underline","")
$("#texttoolbox_underline input").prop("checked")?t.setTextDecoration(e+"underline"):t.setTextDecoration(e),y.renderAll()}}function x(){var t=y.getActiveObject()
if(t&&t.isType("i-text")){var e=t.getTextDecoration().replace("line-through","")
$("#texttoolbox_strikethrough input").prop("checked")?t.setTextDecoration(e+"line-through"):t.setTextDecoration(e),y.renderAll()}}function m(){var t=y.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_edit input").prop("checked")?t.enterEditing():t.exitEditing(),y.renderAll())}function _(t){$("#albumModal").modal("hide"),fabric.Image.fromURL(t,function(t){y.add(t),t.getWidth()*d()>y.getWidth()/2&&t.scaleToWidth(y.getWidth()/2),t.viewportCenter().setCoords(),y.setActiveObject(t),y.renderAll()})}var y,A,k,C={1:{filename:"men1",color:[{id:"1",filename:"blue",color:"0268b0"},{id:"2",filename:"white",color:"ffffff"}]},2:{filename:"women",color:[{id:"3",filename:"black",color:"000000"},{id:"4",filename:"white",color:"ffffff"}]}},w=570,T=20,L="front",j={},O=650,S=500,W=155,F=1e3,X=700
A=new fabric.Canvas("mainCanvas_front",{preserveObjectStacking:!0}),k=new fabric.Canvas("mainCanvas_back",{preserveObjectStacking:!0}),y=A,c(),fabric.Image.fromURL("",function(t){y.add(t),t.scaleToWidth(.8*y.getWidth()),t.viewportCenter().setCoords(),y.renderAll()})
var G=new fabric.IText("",{fill:"#ff0000",stroke:"#000",fontSize:F})
y.add(G),G.scaleToWidth(y.getWidth()/2),G.viewportCenterH().setCoords(),y.renderAll(),A.on("object:selected",t),k.on("object:selected",t),A.on("selection:cleared",e),k.on("selection:cleared",e),A.on("object:modified",o),k.on("object:modified",o),A.on("text:editing:entered",n),k.on("text:editing:entered",n),A.on("text:editing:exited",a),k.on("text:editing:exited",a),A.on("text:changed",r),k.on("text:changed",r),$(window).on("resize",function(){c()}),$("#toolbox_left").on("click",function(){g("Move left")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.setLeft(t.getLeft()-1/d()).setCoords(),y.renderAll()),!1}),$("#toolbox_right").on("click",function(){g("Move right")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.setLeft(t.getLeft()+1/d()).setCoords(),y.renderAll()),!1}),$("#toolbox_up").on("click",function(){g("Move up")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.setTop(t.getTop()-1/d()).setCoords(),y.renderAll()),!1}),$("#toolbox_down").on("click",function(){g("Move down")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.setTop(t.getTop()+1/d()).setCoords(),y.renderAll()),!1}),$("#toolbox_center").on("click",function(){g("Center")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.viewportCenter().setCoords(),y.renderAll()),!1}),$("#toolbox_centerh").on("click",function(){g("Center horizontally")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.viewportCenterH().setCoords(),y.renderAll()),!1}),$("#toolbox_centerv").on("click",function(){g("Center vertically")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.viewportCenterV().setCoords(),y.renderAll()),!1}),$("#toolbox_flipx").on("click",function(){g("Flip vertically")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.setFlipX(!t.getFlipX()),y.renderAll()),!1}),$("#toolbox_flipy").on("click",function(){g("Flip horizontally")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(t.setFlipY(!t.getFlipY()),y.renderAll()),!1}),$("#toolbox_totop").on("click",function(){g("Bring to front")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(y.bringToFront(t),y.renderAll()),!1}),$("#toolbox_tobottom").on("click",function(){g("Send to back")
var t=y.getActiveObject()
return t||(t=y.getActiveGroup()),t&&(y.sendToBack(t),y.renderAll()),!1}),$("#toolbox_remove").on("click",function(){g("Remove")
var t=y.getActiveObject(),e=y.getActiveGroup()
if(e){var o=e.getObjects()
y.discardActiveGroup(),o.forEach(function(t){y.remove(t)})}else t&&y.remove(t)
return!1}),$("input[name=form_shirt_type]","#leftLayoutContainer").on("change",function(){for(var t="",e=0;e<C[this.value].color.length;e++)t+='<div class="btn colorButton '+(0==e?"active":"")+'" style="background-color: #'+C[this.value].color[e].color+';"><input type="radio" name="form_shirt_color" value="'+C[this.value].color[e].id+'" autocomplete="off" '+(0==e?"checked":"")+" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>"
return C[this.value].color.length<2?($("#div_colors_title").hide(),$("#div_colors").html(t).hide()):($("#div_colors_title").show(),$("#div_colors").html(t).show()),$("#img_shirt").attr("src","images/shirts/"+C[this.value].filename+"_"+C[this.value].color[0].filename+"_"+L+".png"),!1}),$("#div_colors").on("change",function(t){return $(t.target).is("input")&&l(),!1}),$("input[name=form_shirt_side]","#centerLayoutContainer").on("change",function(){if(L=this.value,"front"==L?(y=A,$("#div_canvas_back").hide(),$("#div_canvas_front").show()):(y=k,$("#div_canvas_front").hide(),$("#div_canvas_back").show()),y.getActiveObject()||y.getActiveGroup()){$(".cvtoolbox","#centerLayoutContainer").show()
var t=y.getActiveObject()
t&&t.isType("i-text")?(f(t),$(".texttoolbox","#rightLayoutContainer").show()):$(".texttoolbox","#rightLayoutContainer").hide()}else $(".cvtoolbox","#centerLayoutContainer").hide(),$(".cvtoolbox_info","#centerLayoutContainer").hide(),$(".texttoolbox","#rightLayoutContainer").hide()
return l(),!1}),$("#albumModal").on("click",function(t){var e=$(t.target)
return e.is("img")&&e.attr("bgsrc")?(_(e.attr("bgsrc")),!1):void 0}),$("input[name=image_upload]","#leftLayoutContainer").on("change",function(){if(this.value&&this.files&&this.files[0]){var t=$("#frm_upload label i"),e=$("#leftLayoutContainer .message")
t.removeClass("fa-picture-o").addClass("fa-spinner fa-pulse"),e.text("")
var o=new FileReader
o.onload=function(o){$("input[name=image_upload]","#leftLayoutContainer").val(""),t.removeClass("fa-spinner fa-pulse").addClass("fa-picture-o"),e.text(""),fabric.Image.fromURL(o.target.result,function(t){y.add(t),t.getWidth()*d()>y.getWidth()/2&&t.scaleToWidth(y.getWidth()/2),t.viewportCenter().setCoords(),y.setActiveObject(t),y.renderAll()})},o.readAsDataURL(this.files[0])}return!1}),$("#btn_addtext").on("click",function(){$("#leftLayoutContainer .message").text("")
var t=new fabric.IText("Abc",{fill:"#000",stroke:"#000",fontSize:F})
return y.add(t),t.scaleToWidth(y.getWidth()/2),t.viewportCenter().setCoords(),y.setActiveObject(t),y.renderAll(),!1}),$("#reviewModal").on("show.bs.modal",function(){y.deactivateAllWithDispatch(),y.renderAll()
var t=$("#reviewModal .shirtdesign"),e=$("#reviewModal .shirt")
t.find("img").attr("src",y.toDataURL({format:"png",multiplier:Math.ceil(1e4/(d()*F/X))/1e4})),e.find("img").attr("src",$("#img_shirt").attr("src")),t.width(X),e.width(X*w/O),$("#reviewModal .modal-body").height(e.width()),t.css("margin-top",0*e.width()/w)}),navigator.userAgent.match(/iPhone|iPad|iPod/i)&&$(".modal").on("show.bs.modal",function(){$(this).css({position:"absolute",marginTop:$(window).scrollTop()+"px",bottom:"auto"})}),$.each(C,function(t,e){for(t=0;t<e.color.length;t++)(new Image).src="images/shirts/"+e.filename+"_"+e.color[t].filename+"_front.png",(new Image).src="images/shirts/"+e.filename+"_"+e.color[t].filename+"_back.png"}),$(".texttoolbox","#rightLayoutContainer").on("change",function(t){var e=$(t.target)
if(e.is("input")&&e.attr("istool")){switch(e.attr("istool")){case"bold":h()
break
case"italic":v()
break
case"underline":p()
break
case"strikethrough":x()
break
case"edit":m()}return!1}})})
